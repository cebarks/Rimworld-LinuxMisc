name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git describe

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'

      - name: Install just
        uses: extractions/setup-just@v3

      - name: Build release
        run: just release

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: LinuxMisc-*.zip
          generate_release_notes: true

      # Extract mod files for Steam upload
      - name: Extract mod files for Steam
        run: |
          VERSION=$(git describe --tags --always --dirty)
          unzip "LinuxMisc-${VERSION}.zip" -d steam-upload
          mv steam-upload/LinuxMisc steam-upload/mod

      # Determine Workshop Item ID (0 for first upload, stored ID for updates)
      - name: Determine Workshop Item ID
        id: workshop_id
        run: |
          if [ -f "About/PublishedFileId.txt" ]; then
            ITEM_ID=$(cat About/PublishedFileId.txt)
          else
            ITEM_ID="0"
          fi
          echo "item_id=${ITEM_ID}" >> $GITHUB_OUTPUT

      # Upload to Steam Workshop
      - name: Upload to Steam Workshop
        uses: buildalon/upload-steam@v1
        with:
          username: ${{ secrets.STEAM_USERNAME }}
          password: ${{ secrets.STEAM_PASSWORD }}
          app_id: 294100
          workshop_item_id: ${{ steps.workshop_id.outputs.item_id }}
          content_root: steam-upload/mod
          description: "RimWorld Linux Performance Optimizations - ${{ github.ref_name }}"
